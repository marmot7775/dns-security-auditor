def check_dkim(domain: str, selectors: Optional[List[str]] = None) -> Dict[str, Any]:
    """
    Check DKIM records for selectors.
    If selectors is None, checks a built-in list of common selectors.
    """
    if selectors is None:
        selectors = COMMON_DKIM_SELECTORS

    selectors = [s.strip() for s in selectors if s and s.strip()]

    result = {
        "check": "DKIM",
        "domain": domain,
        "selectors_checked": selectors,                 # list, for transparency
        "selectors_checked_count": len(selectors),     # keep a count too
        "selectors_found": [],
        "records": {},
        "record": None,
        "status": "warning",
        "issues": [],
        "warnings": [],
        "recommendations": [],
    }

    found_details = []

    for selector in selectors:
        dkim_name = f"{selector}._domainkey.{domain}"
        records = _lookup_txt_records(dkim_name)

        if not records:
            cnames = _lookup_records(dkim_name, "CNAME")
            if cnames:
                result["selectors_found"].append(selector)
                cname_target = cnames[0].rstrip(".")
                result["records"][selector] = {"type": "CNAME", "target": cname_target}
                found_details.append(f"  {selector}._domainkey.{domain}")
                found_details.append(f"    → CNAME to {cname_target} (delegated signing)")
                continue

        for rec in records:
            if "v=dkim1" in rec.lower() or "p=" in rec.lower():
                result["selectors_found"].append(selector)

                key_type = "rsa"
                if "k=ed25519" in rec.lower():
                    key_type = "ed25519"
                elif "k=rsa" in rec.lower():
                    key_type = "rsa"

                testing = "t=y" in rec.lower()

                if "p=" in rec and ("p=;" in rec or "p= ;" in rec or rec.strip().endswith("p=")):
                    result["records"][selector] = {"type": "TXT", "key_type": key_type, "revoked": True}
                    found_details.append(f"  {selector}._domainkey.{domain}")
                    found_details.append("    → REVOKED (empty public key)")
                else:
                    result["records"][selector] = {"type": "TXT", "key_type": key_type, "testing": testing}
                    mode_str = " [TESTING MODE]" if testing else ""
                    truncated = rec[:80] + "..." if len(rec) > 80 else rec
                    found_details.append(f"  {selector}._domainkey.{domain}")
                    found_details.append(f"    → {key_type.upper()} key{mode_str}")
                    found_details.append(f"    → {truncated}")
                break

    if result["selectors_found"]:
        result["status"] = "ok"
        result["warnings"].append(
            f"DKIM FOUND: {len(result['selectors_found'])} selector(s) discovered: "
            f"{', '.join(result['selectors_found'])}"
        )

        testing_selectors = [s for s, d in result["records"].items() if isinstance(d, dict) and d.get("testing")]
        if testing_selectors:
            result["warnings"].append(
                f"Selector(s) in TESTING mode (t=y): {', '.join(testing_selectors)}."
            )

        revoked_selectors = [s for s, d in result["records"].items() if isinstance(d, dict) and d.get("revoked")]
        if revoked_selectors:
            result["warnings"].append(
                f"Selector(s) REVOKED (empty key): {', '.join(revoked_selectors)}."
            )
    else:
        result["issues"].append(
            f"NO DKIM SELECTORS FOUND. Checked {len(selectors)} selector name(s). "
            "DKIM may still be configured with a custom selector not in the list."
        )
        result["recommendations"].append(
            "To verify DKIM:\n"
            "  1. Check with your email provider for your selector name\n"
            "  2. Send a test email and examine the DKIM-Signature header\n"
            "  3. Common selectors by provider:\n"
            "     • Google Workspace: google, google2\n"
            "     • Microsoft 365: selector1, selector2\n"
        )

    if found_details:
        result["record"] = "DKIM Selectors Found:\n" + "\n".join(found_details)

    return result
